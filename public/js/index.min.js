window.iflicks=function(a){"use strict";function b(a,c){for(c(a),a=a.firstChild;a;)b(a,c),a=a.nextSibling}function c(a,b,d,e){if("string"==typeof a&&(a=document.getElementById(a)),null!==a&&(a.addEventListener?a.addEventListener(b,e):a.attachEvent&&a.attachEvent("on"+b,e),d)){var f=a.type||"button";c(a,b,!1,function(){ga("send","event",f,b,"nav-buttons")})}}function d(a,b){var c={message:a,location:b};window.fetch("error",{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(c)})["catch"](function(a){console.log(a)})}function e(a,b,c){var f,g,h,i,j,k,l,m=9e13,n={};for(g=c,void 0===c&&(c=10),"object"==typeof a&&void 0!==a.message&&(a=a.message),void 0!==a&&console.log((new Date).toUTCString()+" :: "+b+" :: "+a),a&&(c=Date.now()+1e3*c,n.message=a,n.timeout=c,R.push(n)),h=document.createDocumentFragment(),R.forEach(function(a,b){a.timeout<=Date.now()?R.splice(b,1):(k=document.createTextNode(a.message),l=document.createElement("br"),h.appendChild(k),h.appendChild(l),a.timeout<m&&(m=a.timeout))}),j=document.getElementsByClassName("message"),f=0;f<j.length;f++){for(i=j.item(f);i.hasChildNodes();)i.removeChild(i.firstChild);i.appendChild(h.cloneNode(!0))}9e13>m&&(c=m-Date.now(),setTimeout(function(){e()},c)),void 0!==a&&g%2===0&&d(a,b)}function f(a){return(document.cookie.match("(^|; )"+a+"=([^;]*)")||0)[2]}function g(a,b,c){var d,e;c?(e=new Date,e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()):d="",document.cookie=a+"="+b+d+"; path=/"}function h(a){a.classList.remove("hide")}function i(a){a.classList.add("hide")}function j(a){var b=document.getElementById(a);b.className.indexOf("hide")>-1?b.classList.remove("hide"):(b.classList.add("hide1"),setTimeout(function(){b.classList.remove("hide1"),b.classList.add("hide")},300))}function k(a,b){var c={};c[a]=b,window.fetch("option",{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(c)})["catch"](function(a){e(a,"setOption",6)})}function l(a,b){O++,void 0!==P.id&&O%10===0&&(b>a.fileDetail.duration-5&&(b=0),window.fetch("timeupdate/"+a._id+"/"+b,{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}})["catch"](function(a){e(a,"timeUpdate",6)}))}function m(a,b){var c,d,e,f={};if(e=a/b,c=Math.max(document.documentElement.clientWidth||0),d=Math.max(document.documentElement.clientHeight||0),f.viewportWidth=c,f.viewportHeight=d,d>c&&400>c)f.videoWidth=c,f.videoHeight=f.videoWidth/e,f.src="small";else if(d>c&&c>=400&&500>c)f.videoWidth=400,f.videoHeight=f.videoWidth/e,f.src="small";else if(d>c&&c>=500&&800>c)f.videoWidth=500,f.videoHeight=f.videoWidth/e,f.src="medium";else if(d>c&&c>=800)f.videoWidth=880,f.videoHeight=f.videoWidth/e,f.src="big";else if(c>=d&&400>c)f.videoWidth=c,f.videoHeight=f.videoWidth/e,f.src="small";else if(c>=d&&c>=400&&500>c)f.videoWidth=400,f.videoHeight=f.videoWidth/e,f.src="small";else if(c>=d&&c>=500&&900>c)f.videoWidth=500,f.videoHeight=f.videoWidth/e,f.src="medium";else{if(!(c>=d&&c>=900))throw new Error("Unrecognised size");f.videoWidth=880,f.videoHeight=f.videoWidth/e,f.src="big"}return f}function n(){var a,c=document.getElementById("videoFile"),d=document.getElementById("uploadContainer"),f=[],g=new window.FormData;for(g.append(c.name,c.files[0]),b(d,function(a){a.className&&a.className.indexOf("uploadContainer")>-1&&f.push(a)}),a=0;a<f.length;a++)g.append(f[a].name,f[a].value);window.fetch("upload/aa",{method:"PUT",credentials:"include",body:g}).then(function(a){return a.text()}).then(function(a){document.getElementById("uploadForm").reset(),e(a,"uploadFile.msg",5)})["catch"](function(a){e(a,"uploadFile",10)})}function o(a){function d(b){var c=b.target;"Edit"===c.value?(document.getElementById("videoName").contentEditable=!0,document.getElementById("videoName").classList.add("editable"),document.getElementById("videoDescription").contentEditable=!0,document.getElementById("videoDescription").classList.add("editable"),document.getElementById("videoPublic").classList.add("editable"),h(document.getElementById("videoPublic")),document.getElementById("videoDirectLink").classList.add("editable"),h(document.getElementById("videoDirectLink")),c.value="Save"):(document.getElementById("videoName").contentEditable=!1,document.getElementById("videoName").classList.remove("editable"),document.getElementById("videoDescription").contentEditable=!1,document.getElementById("videoDescription").classList.remove("editable"),document.getElementById("videoPublic").classList.remove("editable"),i(document.getElementById("videoPublic")),document.getElementById("videoDirectLink").classList.remove("editable"),i(document.getElementById("videoDirectLink")),w={id:a,name:document.getElementById("videoName").textContent,description:document.getElementById("videoDescription").textContent,"public":document.getElementById("videoPublicCheck").checked,directLink:document.getElementById("videoDirectLinkCheck").checked},c.value="Edit",window.fetch("editvideo",{method:"POST",credentials:"include",body:JSON.stringify(w),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(a){"OK"!==a.All&&e(a.error,"playVideo.btnEditClick.save",10)})["catch"](function(a){console.log("Error"),e(a,"playVideo.btnEditClick.save.1",10)}))}function f(){var a=document.createElement("input");return a.type="button",a.value="Edit",c(a,"click",!0,d),a}function g(){var a=document.createElement("input");return a.type="button",a.value="Send",a.id="btnShowCopy",c(a,"click",!0,function(a){"Send"===a.target.value&&document.getElementById("copyFlickPanel").classList.remove("hide")}),a}function j(a){var c={};c.id=a.target.id.split("_")[1],b(a.target.parentNode,function(a){a.name&&"text"===a.type&&(c[a.name]=a.value)}),window.fetch("copy",{method:"POST",credentials:"include",body:JSON.stringify(c),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(a){"OK"!==a.All?e(a.error,"playVideo.copyFlickClick",10):(e("Received at destination","playVideo.copyFlickClick",5),document.getElementById("copyFlickPanel").classList.add("hide"))})["catch"](function(a){console.log("Error"),e(a,"playVideo.copyFlickClick.1",10)})}function n(a){var b,d,e,f,g;return d=document.createElement("input"),d.type="button",d.value="Send",d.id="copyFlick_"+a,c(d,"click",!0,j),e=document.createElement("input"),e.type="text",e.name="destination",e.placeholder="Destination server",f=document.createElement("input"),f.type="text",f.name="username",f.placeholder="Destination username",g=document.createElement("input"),g.type="text",g.name="password",g.placeholder="Destination password",b=document.createElement("div"),b.className="hide",b.id="copyFlickPanel",b.appendChild(e),b.appendChild(f),b.appendChild(g),b.appendChild(d),b}function o(a,b){var d,f=document.createElement("div"),g=document.createElement("div");for(g.className="ratingContainer",f.className="rating",r=5;r>0;r--)d=document.createElement("i"),b>=r?d.className="fa fa-star":r>b&&b>r-1?d.className="fa fa-star-half-o ":d.className="fa fa-star-o",d.id="rating_"+r,f.appendChild(d);return g.appendChild(f),c(g,"click",!0,function(b){var c=b.target.id.split("_")[1];window.fetch("rating/"+a+"/"+c,{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(d){"OK"!==d.All&&e(d.error,"playVideo.rating.save",7),console.log(b.target.parentNode);var f=b.target.parentNode.parentNode.parentNode;f.removeChild(b.target.parentNode.parentNode),f.appendChild(o(a,c))})["catch"](function(a){e(a,"timeUpdate",6)})}),g}function p(){s=M.fileDetail&&M.fileDetail.width?m(M.fileDetail.width,M.fileDetail.height):m(800,600),v.innerHTML='<video id="video" poster="thumb/'+a+"/"+s.src+'" data-setup="{}"  class="video-js vjs-default-skin" ><source src="video/'+a+"/"+s.src+".mp4?r="+(new Date).getTime()+'" type="video/mp4"></source><source src="video/'+a+"/"+s.src+".webm?r="+(new Date).getTime()+'" type="video/webm"></source><source src="video/'+a+"/"+s.src+".ogv?r="+(new Date).getTime()+'" type="video/ogg"></source></video><div ></div>',q={controls:!0,autoplay:!1,preload:"auto",width:s.videoWidth,height:s.videoHeight},K=videojs(document.getElementById("video"),q,function(){}),M.currentTime&&K.currentTime(M.currentTime),K.on("error",function(a){e(a.message,"playVideo.setVideoDetail.vjs.error",10)}),K.one("play",function(){window.fetch("playVideo/"+a,{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()})}),K.on("volumechange",function(a){P.options.volume=a.target.volume,k("volume",a.target.volume)}),K.on("timeupdate",function(){l(M,K.currentTime())}),P.options&&P.options.volume&&K.volume(P.options.volume),u=document.createElement("div"),u.id="videoInfo",t=document.createElement("div"),t.id="videoName",t.className="videoTextItem",t.textContent=M.name,u.appendChild(t),t=document.createElement("div"),t.id="videoDescription",t.className="videoTextItem",t.textContent=M.description,u.appendChild(t),x=document.createElement("div"),x.id="videoPublic",x.className="videoTextItem",x.textContent="Public",y=document.createElement("input"),y.id="videoPublicCheck",y.type="checkbox",y.name="public",y.checked=M["public"],i(x),x.appendChild(y),u.appendChild(x),z=document.createElement("div"),z.id="videoDirectLink",z.className="videoTextItem",z.textContent="Allow direct link",A=document.createElement("input"),A.id="videoDirectLinkCheck",A.type="checkbox",A.name="directLink",A.checked=M.directLink,i(z),z.appendChild(A),u.appendChild(z),t=document.createElement("div"),t.id="videoRunCount",t.className="videoTextItem",t.textContent="Played "+M.playCount+" time"+(1===M.playCount?"":"s"),u.appendChild(t),void 0===P.id||M.userId!==P.id&&P.isSysAdmin!==!0||(u.appendChild(f()),u.appendChild(g())),u.appendChild(o(a,M.rating)),u.appendChild(n(a)),v.appendChild(u)}var q,r,s,t,u,v,w,x,y,z,A;for(document.getElementById("videoList").classList.add("hide"),v=document.getElementById("videoContainer"),v.classList.remove("hide"),clearInterval(I),r=0;r<Q.length;r++)if(Q[r]._id===a){M=Q[r];break}M?p():window.fetch("videodetail/"+a,{credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(a){a.error?e(a.error,"playVideo.fetchVideoDetail",10):(M=a,p())})["catch"](function(a){console.log("Error"),e(a.message,"playVideo.fetchVideoDetail1",10)})}function p(a){var b,d,e,f,g,h,i,j;for(d=a.data,e=document.getElementById("videoList");e.firstChild;)e.removeChild(e.firstChild);if(void 0!==d){f=document.createDocumentFragment(),d.forEach(function(a,d){function k(){var b=window.history.state||{};b.method="listVideos",b.scrollTop=document.body.scrollTop,b.page=a.page,b.limit=a.limit,b.search=a.search,window.history.replaceState(b,"List video",""),window.history.pushState({method:"playVideo",vid:a._id},"Play video","/"+a._id),o(a._id)}var l,m,n,p,q,r,s;l=document.createElement("div");var u=document.createTextNode(" ");if(g=document.createElement("div"),p=document.createElement("i"),m=document.createElement("div"),n=document.createElement("img"),h=document.createElement("span"),q=document.createElement("div"),i=document.createTextNode(a.name),r=document.createElement("span"),r.innerHTML=a.description,j=document.createElement("i"),l.className="vidContainer",g.className="vidContent",p.className="fa fa-spinner fa-pulse fa-5x",m.className="vidThumbContainer hide1",n.className="vidThumb",q.className="vidFooter",h.className="vidName",j.className="fa fa-trash-o vidDelete",n.src="thumb/"+a._id+"/thumb",c(n,"error",!1,function(){n.src="img/missing.png"}),c(n,"load",!0,function(){m.classList.remove("hide1"),m.parentNode.removeChild(m.parentNode.children[0])}),r.className="vidDescription",h.appendChild(i),g.appendChild(p),m.appendChild(n),g.appendChild(m),q.appendChild(h),g.appendChild(q),l.appendChild(u),l.appendChild(g),l.appendChild(r),(a.userId===P.id||P.isSysAdmin===!0)&&l.appendChild(j),f.appendChild(l),a.encoded===!0){var v;c(l,"mousedown",!0,function(a){v=void 0,s=setTimeout(function(){v=a.target,v.classList.add("hide1")},500)}),c(l,"mouseout",!1,function(){clearTimeout(s),v&&v.classList.remove("hide1")}),c(l,"mouseup",!0,function(a){clearTimeout(s),v&&v.classList.remove("hide1"),void 0===v&&0===a.button&&k()})}c(j,"mouseup",!0,function(c){for(clearTimeout(s),t(a._id),e.removeChild(l),b=0;b<Q.length;b++)if(Q[b]._id===a._id){Q.splice(b,1);break}c.stopPropagation()}),d%10===0&&(e.appendChild(f),f=document.createDocumentFragment())}),e.appendChild(f);var k,l,m;k=document.createElement("div"),l=document.createElement("span"),m=document.createElement("span"),l.textContent="Next",m.textContent="Previous",k.id="nextPrev",l.className="nextPrev",m.className="nextPrev",c(l,"click",!0,function(){q(a.page+1,a.limit,a.search)}),c(m,"click",!0,function(){q(a.page-1,a.limit,a.search)}),a.page>0&&k.appendChild(m),a.count>(a.page+1)*a.limit&&k.appendChild(l),e.appendChild(k)}}function q(a,b,c){var d,f,g,h,i;for(a=a||0,b=b||10,c=c||"-",L=0,M=void 0,g=document.getElementById("videoList"),g.classList.remove("hide"),document.getElementById("videoListUnencoded").classList.add("hide"),h=document.getElementById("videoContainer"),h.classList.add("hide");h.firstChild;)h.removeChild(h.firstChild);for(f=document.getElementById("video"),null!==f&&videojs(f).dispose(),i=document.getElementsByClassName("newVideoPopup"),d=0;d<i.length;d++)i[d].parentNode.removeChild(i[d]);clearInterval(I),Q.length>0?g.children.length!==Q.length&&p(Q):window.fetch("videolist/"+a+"/"+b+"/"+c,{credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(a){Array.isArray(a.data)?(Q=a,p(Q)):e("Non array type returned.","listtVideos.fetchVideoList",6)})["catch"](function(a){e(a,"listtVideos.fetchVideoList1",10)})}function r(){void 0!==window.EventSource&&(J=new window.EventSource("newvideo"),c(J,"newVideo",!1,function(){var b=document.createElement("div");L++,b.className="newVideoPopup",b.innerHTML="<p>There are "+L+" new videos</p>",c(b,"click",!0,function(){window.history.pushState({method:"listVideos",vid:vid._id},"List video","/"),q(0,a.videoListPageLength)}),document.body.appendChild(b),setTimeout(function(){b.parentNode.removeChild(b)},6e3)}))}function s(a,b){function c(){window.fetch("videolistunencoded/"+a+"/"+b,{credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return a.json()}).then(function(a){Array.isArray(a.data)?p(a):e("Non array type returned.","listUnencoded.getUnencoded",6)})["catch"](function(a){e(a,"listUnencoded.getUnencoded1",6)})}var d,f,g;for(M=void 0,f=document.getElementById("videoList"),f.classList.remove("hide"),document.getElementById("videoListUnencoded").classList.add("hide"),g=document.getElementById("videoContainer"),g.classList.add("hide");g.firstChild;)g.removeChild(g.firstChild);d=document.getElementById("video"),null!==d&&videojs(d).dispose(),c(),clearInterval(I),I=setInterval(c,5e3)}function t(a){window.fetch("video/"+a,{credentials:"include",method:"DELETE"})["catch"](function(a){e(a,"deleteVideo.fetch",6)})}function u(a){var b,c,d=!0,f={};for(b=0;b<a.target.parentNode.childNodes.length;b++)c=a.target.parentNode.childNodes[b],"text"===c.type?(f[c.name]=c.value,c.value.length<2&&(d=!1,e(c.name+" is required.","addUserHandler",5))):"checkbox"===c.type&&(f[c.name]=c.checked);d&&window.fetch("/user",{credentials:"include",method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(f)}).then(function(a){return a.json()}).then(function(a){a.error?e(a.error,"addUserHandler.fetchUser",6):a.reply?(e(a.reply,"addUserHandler.fetchUser1",7),j("createAccountContainer")):e("Unexpected response","addUserHandler.fetchUser2",10)})["catch"](function(a){e(a.message,"addUserHandler.fetchUser3",10)})}function v(){j("uploadContainer")}function w(){j("createAccountContainer")}function x(){"true"===f("cookieConsent")&&null!==document.getElementById("cookieBanner")&&(document.getElementById("cookieBanner").className="hide")}function y(){document.getElementById("cookieBanner").className="hide",g("cookieConsent","true",1)}function z(){document.getElementById("infoContainer").className="hide",g("closeInfoPanel","true",1)}function A(){Object.getOwnPropertyNames(P).length>0&&(P.options||(P.options={}),P.options.volume&&K&&K.volume(P.options.volume),document.getElementById("loggedinContainer").style.display="inline-block",document.getElementById("loginContainer").style.display="none",document.getElementById("showUploadContainer").style.display="inline-block",document.getElementById("headerBarUserName").textContent="Hello "+P.forename,document.getElementById("message").textContent="",p(Q))}function B(){window.fetch("login",{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({username:document.getElementById("username").value,password:document.getElementById("password").value})}).then(function(a){return a.json()}).then(function(a){a.error?e(a.error,"login.fetchLogin",7):(P=a,A())})["catch"](function(a){e(a,"login.fetchLogin1",6)})}function C(){window.fetch("login",{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return 401===a.status?{}:a.json()}).then(function(a){Object.getOwnPropertyNames(a).length>0&&(P=a,A())})["catch"](function(a){e(a,"loginCheck.fetchLogin",6)})}function D(){P={},document.getElementById("loggedinContainer").style.display="none",document.getElementById("loginContainer").style.display="inline-block",document.getElementById("showUploadContainer").style.display="inline-block",document.getElementById("message").textContent="",document.getElementById("headerBarUserName").textContent="",window.fetch("login",{method:"DELETE",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}})["catch"](function(a){e(a,"logout.fetchLogin",6)})}function E(){var a,b,c,d,f=3422856,g=new Image;g.onload=function(){b=(new Date).getTime(),c=(b-a)/1e3,d=f/c/1024/1024,1>d&&(d=(1.8*d).toFixed(2),e("The internet speed between you and us is slow ("+d+" Mbps) so these videos may not play smoothly.","downloadSpeedTest",7))},a=(new Date).getTime(),g.src="img/random.jpg?n="+a}function F(){return!!document.createElement("video").canPlayType}function G(a){return void 0===window.FormData||F()!==!0?void(document.getElementById("body").innerHTML="<p>Your browser is not supported.  i-flicks is supported by all modern browsers.  It doesn't work on old versions of Internet Explorer or old mobile browsers.</p>"):void a()}function H(){G(function(){c("submitUploadNewVideo","click",!0,n),c("submitLogin","click",!0,B),c("submitLogout","click",!0,D),c("closeInfoPanel","click",!0,z),c("submitCookieAccept","click",!0,y),c("showUploadContainer","click",!0,v),c("showCreateAccount","click",!0,w),c("submitCreateAccount","click",!0,u),c("showVideoList","click",!0,function(){window.history.pushState({method:"listVideos",vid:vid._id},"List video","/"),q(0,a.videoListPageLength)}),c("showUnencodedVideoList","click",!0,function(){window.history.pushState({method:"listUnencoded"},"List unencoded videos","/"),s(0,a.videoListPageLength)}),c(window,"popstate",!0,function(a){console.log("POPSTATE: "+a.state.method),"playVideo"===a.state.method?o(a.state.vid):"listVideos"===a.state.method&&(q(a.state.page,a.state.limit,a.state.search),void 0!==a.state.scrollTop&&a.state.scrollTop>0&&window.scroll(a.state.scrollTop,0))}),c(window,"resize",!0,function(){var a,b,c;void 0!==M&&M.fileDetail&&M.fileDetail.width&&N!==window.orientation&&(N=window.orientation,a=m(M.fileDetail.width,M.fileDetail.height),b=K.currentTime(),c=K.paused(),K.dimensions(a.videoWidth,a.videoHeight),K.src([{type:"video/mp4",src:"video/"+M._id+"/"+a.src+".mp4?r="+(new Date).getTime()},{type:"video/webm",src:"video/"+M._id+"/"+a.src+".webm?r="+(new Date).getTime()}]),K.currentTime(b),c||K.play())}),C(),r(),q(0,a.videoListPageLength),E()}),x()}var I,J,K,L,M,N,O=0,P={},Q=[],R=[],S=new Image;return a.videoListPageLength=a.videoListPageLength||10,S.src="img/loading.gif",N=window.orientation,P.options={},H(),{playVideo:o}}({});